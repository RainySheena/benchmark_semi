## Read the datasets
```{r}
library(Matrix)
library(Seurat)
library(patchwork)
library(SeuratData)
library(ggplot2)
library(cluster)
library(dplyr)
library(SeuratDisk)

```

```{R}
# no need to run every time
# Convert the .h5ad file to .h5seurat
Convert("./lung_atlas_public/lung_atlas_public.h5ad", dest = "h5seurat", overwrite = TRUE)

# Load the .h5seurat file into a Seurat object with specific assays
seurat_obj <- LoadH5Seurat("./lung_atlas_public/lung_atlas_public.h5seurat", assays = "RNA")

# Save the Seurat file
saveRDS(seurat_obj, file = "./lung_atlas_public/lung_atlas_raw.rds")

# Print the Seurat object to verify the conversion
print(seurat_obj)
```

```{r}
# Next time, just read the RDS file for Seurat objects
seurat_obj = readRDS("./lung_atlas_public/lung_atlas_raw.rds")

# Increase the maximum allowed size for globals in the future package
options(future.globals.maxSize = 16 * 1024^3) 

# Perform integration with SCTransform-normalized datasets
original_cell_order <- colnames(seurat_obj@assays$RNA@counts)

seurat_obj[["RNA"]] <- split(seurat_obj[["RNA"]], f = seurat_obj$batch)
seurat_obj <- SCTransform(seurat_obj)

seurat_obj <- RunPCA(seurat_obj, npcs = 50, verbose = F)

seurat_obj <- IntegrateLayers(
  object = seurat_obj, method = RPCAIntegration,
  new.reduction = "integrated.rpca", normalization.method = "SCT",
  verbose = FALSE
)
```

```{r}
# Compute neighbors and UMAP
seurat_obj <- FindNeighbors(seurat_obj, dims = 1:30, reduction = "integrated.rpca")
seurat_obj <- RunUMAP(seurat_obj, dims = 1:30, reduction = "integrated.rpca")

# Plot the UMAP results
DimPlot(seurat_obj, reduction = "umap", group.by = "batch") + ggtitle("UMAP colored by Batch")
DimPlot(seurat_obj, reduction = "umap", group.by = "cell_type") + ggtitle("UMAP colored by Cell Type")

```


